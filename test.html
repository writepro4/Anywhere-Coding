<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

</head>
<body>

<!--로그인 코드-->
<script>

    // 토큰 가져오는 함수
    function get_csrf(callback) {
        console.log("실행");

        $.ajax({
            type: 'get'
            , url: 'https://honeytip.p-e.kr/csrf_token'
            , data: ''
            , xhrFields: {
                withCredentials: false
            }
            , success: function (data) {
                console.log(data);
                // 콜백메소드로 토큰 값 반환
                $("#text").html(data);	// 전송받은 데이터와 전송 성공 여부를 보여줌.
                callback(data); // 받아온 csrf_token을 반환해주는 부분
                console.log("받아온 토큰값: " + data);
            }
            , error: function (xhr, status, msg) {
                console.log(xhr);
                console.log(status);
                console.log(msg);
                console.log("토큰 발행 실패");
            }
        });
    }

    // 데이터 전송 함수
    function test_ajax1(csrf_token) {
        console.log("데이터 전송 함수 실행");
        console.log("넘겨줄 토큰값: " + csrf_token);
        //데이터 전송 예제
        let login_data = {
            '_token': csrf_token, //이부분에서 '_token'이라는 key로 csrf_token값을 전달해 주어야 한다
            'id': "tip12",
            'pw': "honey"
        };
        console.log(login_data);

        // let myJSON = JSON.stringify(login_data);
        // console.log(myJSON);
        $.ajax({
            type: 'post'
            , url: 'https://honeytip.p-e.kr/login/auth'
            , data: login_data
            , xhrFields: {
                withCredentials: false
            }
            , success: function (data) {
                $("#text2").html(data);	// 전송받은 데이터와 전송 성공 여부를 보여줌.
                //json 해체
                let parse_data = JSON.parse(data);
                //위의 코드 없으면 문자형
                console.log(parse_data);
                console.log("전송 성공");
                let check = parse_data.key;
                console.log(check);
                if(check === true){
                    window.location.replace("./administrator_page.html");
                }else{
                    alert("다시 시도해주세요.");
                }
            }
            //에러 종류 조건문으로 걸러내기
            , error: function (jqXHR, exception) {

                if (jqXHR.status === 0) {
                    alert('Not connect.\n Verify Network.');
                } else if (jqXHR.status === 400) {
                    alert('Server understood the request, but request content was invalid. [400]');
                } else if (jqXHR.status === 401) {
                    alert('Unauthorized access. [401]');
                } else if (jqXHR.status === 403) {
                    alert('Forbidden resource can not be accessed. [403]');
                } else if (jqXHR.status === 404) {
                    alert('Requested page not found. [404]');
                } else if (jqXHR.status === 500) {
                    alert('Internal server error. [500]');
                } else if (jqXHR.status === 503) {
                    alert('Service unavailable. [503]');
                } else if (exception === 'parsererror') {
                    alert('Requested JSON parse failed. [Failed]');
                } else if (exception === 'timeout') {
                    alert('Time out error. [Timeout]');
                } else if (exception === 'abort') {
                    alert('Ajax request aborted. [Aborted]');
                } else {
                    alert('Uncaught Error.n');
                }
                console.log("상태: " + status);
                console.log("실패");
            }
        });
    }

    // (토큰,요청함수 묶은 메소드)
    function get_token() {
        get_csrf(function (csrf_token) {
            test_ajax1(csrf_token)
        })
    }

</script>


<button id="MembershipButton" onclick=get_token();>버튼</button>
<div id="text">안녕하세요.</div>
<div id="text2">안녕하세요.</div>


</body>
</html>